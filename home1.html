<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>劳务管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/clear.css">
    <link rel="stylesheet" href="./css/home.css">
    <script src="./js/jquery.min.js"></script>
    <link rel="stylesheet" href="./js/layui/dist/css/layui.css">
    <script src="./js/layui/dist/layui.js"></script>
    <script src="./js/echarts.min.js"></script>
</head>
<body style="position: relative; overflow: hidden">
<div id="screen">

    <div id="header" style="width: 100%; height: 101px; vertical-align: middle"></div>

    <div id="plate_nav">
        <div class="plate_item">
            <div class="plate_box">
                <div class="plate_til">劳务队伍</div>
                <div class="plate_num">
                    <p>
                        <span id="laborNumber">0</span>
                        <span class="unit">/个</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box">
                <div class="plate_til">累计进场</div>
                <div class="plate_num">
                    <p>
                        <span id="entryCountTotal">0</span>
                        <span class="unit">/人</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box">
                <div class="plate_til">当前在场</div>
                <div class="plate_num">
                    <p>
                        <span id="entryCountCurrent">0</span>
                        <span class="unit">/个</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box">
                <div class="plate_til">本月出勤</div>
                <div class="plate_num">
                    <p>
                        <span id="attendCount">0</span>
                        <span class="unit">/人</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="plate_item">
            <div class="plate_box">
                <div class="plate_til">本月缺勤</div>
                <div class="plate_num">
                    <p>
                        <span id="abnormalCount">0</span>
                        <span class="unit">/人</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box">
                <div class="plate_til">本月旷工</div>
                <div class="plate_num">
                    <p>
                        <span id="offworkCount">0</span>
                        <span class="unit">/人</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box">
                <div class="plate_til">未培训</div>
                <div class="plate_num">
                    <p>
                        <span id="trainOffCount">0</span>
                        <span class="unit">/人</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <main style="align-content: space-between">
        <div class="charts_content_box">
            <div class="content-header">
                <span class="ch-tit">工种统计TOP5</span>
            </div>
            <div class="main_body">
                <div id="JobStatistics" class="pie_chart"></div>
            </div>
        </div>
        <div class="charts_content_box">
            <div class="content-header">
                <span class="ch-tit">年龄统计</span>
            </div>
            <div class="main_body">
                <div id="AgeStatistics" class="pie_chart"></div>
            </div>
        </div>
        <div class="charts_content_box">
            <div class="content-header">
                <span class="ch-tit">近7天出勤率（%）</span>
            </div>
            <div class="main_body">
                <div id="CurrentPeriodStatistics" class="normal_chart"></div>
            </div>
        </div>
        <div class="charts_content_box">
            <div class="content-header">
                <span class="ch-tit">劳务人员所属区域TOP5</span>
            </div>
            <div class="main_body">
                <div id="AreaStatistics" class="normal_chart"></div>

            </div>
        </div>

        <div class="charts_content_box">
            <div class="content-header">
                <span class="ch-tit">近30天劳务队伍进退场TOP5</span>
<!--                <div class="nav_tit active">-->
<!--                    <span class="ch-tit">本期出勤劳务队伍TOP5</span>-->
<!--                </div>-->
<!--                <div class="nav_tit ">-->
<!--                    <span class="ch-tit">近30天劳务队伍进退场TOP5</span>-->
<!--                </div>-->
            </div>
            <div class="main_body">
<!--                <div class="nav_tab_content" style="display: block">-->
<!--                    <div id="AttendanceTeamTop5" class="normal_chart"></div>-->
<!--                </div>-->
<!--                <div class="nav_tab_content">-->
<!--                    <div id="InOutTeamTop5" class="normal_chart"></div>-->
<!--                </div>-->
                <div id="InOutTeamTop5" class="normal_chart"></div>
            </div>
        </div>
        <div class="charts_content_box">
            <div class="content-header">
                <span class="ch-tit">劳务队伍人数及出勤率</span>
            </div>
            <div class="main_body">
                <div id="TeamTable" class="main_body_table">
                    <table id="table"></table>
                </div>
            </div>
        </div>
    </main>

    <div id="Modal" class="modal_content" style="display: none">
        <div class="modal_header">
            <span>本地出勤</span>
            <i class="layui-icon layui-icon-close" onclick="closeModal()"></i>
        </div>
        <div class="modal_body main_body_table" id="Modal_Main_Body">
            <table id="modalTable"></table>
        </div>
    </div>

    <div id="mark" style="
        display: none;
        width: 100%;
        height: 100%;
        position: fixed;
        left: 0;
        top: 0;
        background: rgba(0,0,0, .5);
    "></div>

</div>

<canvas id="canvas" ></canvas>

<script src="./js/common.js"></script>

<script>
    var form, table;
    var Charts = {}

    var pieOptions = {
        color: ['#173DAA', '#CE7525', '#18A89D', '#BF2E4A', '#BF23CC']
    }

    $("#header").load('_header.html')

    layui.use(['form', 'table'], function () {
        form = layui.form
        table = layui.table
        form.render('select')
        renderTable()
    })

    function openModal() {
        $("#mark").show()
        $("#Modal").fadeIn()
        renderModalTable()
    }

    function closeModal() {
        $("#Modal").fadeOut()
        $("#mark").hide()
    }


    // 渲染头部数据
    function renderHeaderData() {
        parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainTop", undefined , true, {}, function (re) {
            if (re.code == 1) {
                if (re.data != null) {
                    $("#laborNumber").text(re.data.laborNumber)
                    $("#entryCountTotal").text(re.data.entryCountTotal)
                    $("#entryCountCurrent").text(re.data.entryCountCurrent)
                    $("#attendCount").text(re.data.attendCount)
                    $("#abnormalCount").text(re.data.abnormalCount)
                    $("#offworkCount").text(re.data.offworkCount)
                    $("#trainOffCount").text(re.data.trainOffCount)
                }
            }
        });
    }



    function renderModalTable() {
        parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainLaborOnlinePeoplePageList", {  pageIndex:0 ,pageSize: 300 } , false, {}, function (re) {
            if (re.code == 1) {
                var data = re.data.list || []
                table.render({
                    elem: '#modalTable',
                    height: $("#modalTable").parent().height() - 20,
                    data: data,
                    cols: [
                        [
                            {field: 'enterpriseLaborName', width: '30%', title: '劳务队伍', templet: function (d) {
                                    return d.enterpriseLaborName + '-' + d.enterpriseAgentName
                                }
                            },
                            {field: 'epTeamName',title: '班组类型'},
                            {field: 'monitorName',title: '班组长'},
                            {field: 'name',title: '工人姓名'},
                            {field: 'idCard',width: '20%', title: '身份证号'},
                            {field: 'entryTime',width: '15%', type:'date', title: '进场日期', templet: function (d) { return new Date(d.entryTime).pattern("yyyy-MM-dd")}},
                        ]
                    ],
                    limit: data.length,
                    done: function () {
                        $("#Modal_Main_Body .layui-table-body").layTableScroll()
                    }
                })
            }
        })

    }

    // 劳务队伍人数及出勤率
    function renderTable() {

            parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainMidRateChart", undefined , true, {}, function (re) {
                if (re.code == 1) {
                    table.render({
                        elem: '#table',
                        height: $("#table").parent().height() - 20,
                        data: re.data,
                        cols: [
                            [
                                {field: 'name', width: '50%', title: '劳务队伍'},
                                {field: 'rate', width: '28%', title: '本期出勤率（%）'},
                                {field: 'peopleCount', width: '20%',title: '劳务人数'},
                            ]
                        ],
                        limit: re.data.length,
                        done: function () {
                            $("#TeamTable .layui-table-body").layTableScroll()
                        }
                    })

                }
            })
    }

    // 工种统计top5
    function gainWorkerTypeChart() {
        parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainWorkerTypeChart", undefined , true, {}, function (re) {
            if (re.code == 1) {
                initPieChart($("#JobStatistics")[0], "JobStatistics",
                    re.data,
                    Object.assign(pieOptions, {

                        series: {
                            radius: '60%'
                        },
                        itemGap: 15,

                    })
                )
            }
        });
    }

    // 年龄统计top5
    function gainAgeChart() {
        parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainAgeChart", undefined , true, {}, function (re) {
            if (re.code == 1) {
                initPieChart($("#AgeStatistics")[0], "AgeStatistics",
                    re.data,
                    Object.assign(pieOptions, {
                        series: {
                            radius: '60%'
                        },
                        itemGap: 15
                    })
                )
            }
        });
    }

    // 近7期出勤率
    function gainProjRateChart() {
        parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainProjRateChart", undefined , true, {}, function (re) {
            if (re.code == 1) {
                initLineChart($("#CurrentPeriodStatistics")[0], 'CurrentPeriodStatistics', re.data.map(function (item) {return item.name.replace(",", "\n")})
                    , re.data.map(function (item) {return item.value}))
            }
        });
    }
    // 所属区域top5
    function gainRegionChart() {
        parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainRegionChart", undefined , true, {}, function (re) {
            if (re.code == 1) {
                initCategoryChart($("#AreaStatistics")[0], 'AreaStatistics', re.data.map(function (item){ return item.name })
                    , re.data.map(function (item){ return item.value }))
            }
        });
    }
    // 近30天劳务队伍进退场
    function gainMidEntryExitChart() {
        parentPublic.publicPostAjax(parentPublic.middleURL + "/laborScreen/gainMidEntryExitChart", undefined , true, {}, function (re) {
            if (re.code == 1) {
                initBarChart($("#InOutTeamTop5")[0], 'InOutTeamTop5',
                    re.data.map(function (item){return item.name.replace("-", "\n")})
                , {name: '进场', data:  re.data.map(function (item){return item.entryCount}) }, {name: '退场', data: re.data.map(function (item){return item.exitCount})})
            }
        });
    }
    $(function () {
        // 渲染头部数据
        renderHeaderData()

        gainWorkerTypeChart()

        gainAgeChart()

        gainProjRateChart()


        gainRegionChart()

        gainMidEntryExitChart()

    })

    function initPie3DChart() {
        var chart = {
            type: 'pie',
            options3d: {
                enabled: true,
                alpha: 45
            },
            spacing: [30, 120, 105, -80],
            backgroundColor: "#141540",
            dataLabels: {
                enabled: false
            }
        };

        var plotOptions = {
            pie: {
                depth: 80
            },
            dataLabels: {
                enabled: false
            }
        };
        var series = [{
            name: '配送量',
            data: [
                ['Bananas', 8],
                ['Kiwi', 3],
                ['Mixed nuts', 1],
                ['Oranges', 6],
                ['Apples', 8],
                ['Pears', 4],
                ['Clementines', 4],
                ['Reddish (bag)', 1],
                ['Grapes (bunch)', 1]
            ]
        }];

        var json = {};
        json.chart = chart;
        json.title = '';
        json.plotOptions = plotOptions;
        json.series = series;
        $('.pie_chart').highcharts(json);
    }



    function initBarChart(ele, name, xdata, data1, data2, opt) {
        var chart = echarts.init(ele);


        var option = {
            tooltip: {},
            color: ['#37D1CE', '#FF9125'],
            legend: {
                top: '2%',
                right: '5%',
                icon: 'rect',
                textStyle: {
                    color: '#FEFFFF',
                    fontSize: 16
                }
            },
            xAxis: {
                data: xdata,
                axisLabel: {
                    show: true,
                    onZero: true,
                    textStyle: {
                        fontSize: 16,
                        color: '#FEFFFF'
                    }
                },
                splitLine: {show: false},
                splitArea: {show: false}
            },
            yAxis: {

                splitLine: {
                    lineStyle: {
                        color: [splitLineColor]
                    }
                },
                axisLabel: {
                    show: true,
                    textStyle: {
                        fontSize: 16,
                        color: '#FEFFFF'
                    }
                }
            },
            grid: {
                x: 20,
                y: 60,
                x2: 20,
                y2: 20,
                containLabel: true,
                borderWidth: 1
            },
            series: [
                {
                    name: data1.name,
                    type: 'bar',
                    stack: 'one',
                    barWidth: 30,
                    data: data1.data
                },
                {
                    name: data2.name,
                    type: 'bar',
                    stack: 'one',
                    barWidth: 30,
                    data: data2.data,
                },
            ]
        };

        option.series[0].itemStyle = option.series[1].itemStyle = {
            normal: {
                label: {
                    show: true,
                    position: 'top',
                    textStyle: {
                        fontSize: 16,
                        color: '#FEFFFF'
                    },
                    formatter: function (params) {
                        // console.log(params)
                        if (params.data == 0) return ''
                        return params.data
                    }
                },
            }
        }

        option = deepMerge(option, opt)

        chart.setOption(option);
        Charts[name] = chart
    }


    $(window).resize(() => {
        for (var key in Charts) {
            if (!Charts[key]) continue
            Charts[key].resize()
        }
    });

</script>
<!--<script src="./js/bigscreen.js"></script>-->
<script src="./js/echarts-component.js"></script>
<script src="./js/screenfull.min.js"></script>
</body>
</html>