<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>隐患排查治理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/clear.css">
    <link rel="stylesheet" href="./css/home.css">
    <script src="./js/jquery.min.js"></script>
    <link rel="stylesheet" href="./js/layui/dist/css/layui.css">
    <script src="./js/layui/dist/layui.js"></script>
    <script src="./js/echarts.min.js"></script>

    <style>

    </style>
</head>
<body style="position: relative; overflow: hidden">
<div id="screen">

    <div id="header" style="width: 100%; height: 101px; vertical-align: middle" ></div>

    <div id="plate_nav" style="padding: 14px 0 27px 0;;">
        <div class="plate_item">
            <div class="plate_box_long">
                <div class="plate_til">项目部得分</div>
                <div class="plate_num">
                    <p>
                        <span id="score">0</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box_long">
                <div class="plate_til">项目部排名</div>
                <div class="plate_num">
                    <p>
                        <span id="ranking">0</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box_long">
                <div class="plate_til">本期隐患数量</div>
                <div class="plate_num">
                    <p>
                        <span id="flawCnt">0</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box_long">
                <div class="plate_til">本期待整改</div>
                <div class="plate_num">
                    <p>
                        <span>0</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="plate_item">
            <div class="plate_box_long">
                <div class="plate_til">超期未销项</div>
                <div class="plate_num">
                    <p>
                        <span>0</span>
                    </p>
                </div>
            </div>
        </div>

    </div>
    <main>
        <div class="charts_content_box_280" style="height: 280px">
            <div class="content-header">
                <span class="ch-tit">本月整改情况</span>
            </div>
            <div class="main_body">
                <div id="MonthUpdate" class="pie_chart"></div>
            </div>
        </div>


        <div class="charts_content_box_280" style="height: 280px">
            <div class="content-header">
                <span class="ch-tit">隐患上报排行TOP5</span>
            </div>
            <div class="main_body">
                <div id="Top5" class="pie_chart"></div>
            </div>
        </div>

        <div class="charts_content_box_280" style="height: 280px">
            <div class="content-header">
                <span class="ch-tit">隐患等级统计</span>
            </div>
            <div class="main_body">
                <div id="Level" class="pie_chart"></div>
            </div>
        </div>

        <div class="charts_content_box charts_content_box_1251" style="height: 280px; ">
            <div class="content-header">
                <span class="ch-tit">隐患趋势统计</span>

                <div class="nav_tit nav_tit_right" style="margin-right: 20px" onclick="getFlawTrend(2)">
                    <span class="ch-tit">月</span>
                </div>
                <div class="nav_tit nav_tit_right active"  onclick="getFlawTrend(1)">
                    <span class="ch-tit">近7天</span>
                </div>
            </div>
            <div class="main_body">
                <div id="Statistics" class="normal_chart"></div>
            </div>
        </div>

        <div class="charts_content_box_280" style="height: 280px">
            <div class="content-header">
                <span class="ch-tit">隐患专业情况</span>
            </div>
            <div class="main_body">
                <div id="State" class="normal_chart"></div>
            </div>
        </div>

        <div class="charts_content_box charts_content_box_220" style="width: 100%; height: 220px">
            <div class="content-header">
                <span class="ch-tit">风险清单一览表</span>
            </div>
            <div class="main_body" >
                <div id="TeamTable" class="main_body_table">
                        <table id="table"></table>
                </div>
            </div>
        </div>
    </main>


</div>
<canvas id="canvas" ></canvas>
<script src="./js/common.js"></script>

<script>
    var form, table;
    var Charts = {}



    layui.use(['form' ,'table'], function (){
        form = layui.form
        table = layui.table
        form.render('select')
        renderTable()
    })

    function renderTable() {
        parentPublic.publicGetAjax(parentPublic.middleURL + "/flawScreen/getFlawDetail", undefined , true, {}, function (re) {
            if (re.code == 1) {
                    console.log('getFlawDetail', re.data)

                    table.render({
                        elem: '#table',
                        height: $("#table").parent().height() - 20,
                        // height: 'full-100',
                        data: re.data,
                        cols: [
                            [
                                { field: 'content', title: '隐患内容',  },
                                { field: 'flawLevel', title: '隐患等级',  },
                                { field: 'measure', title: '整改内容',  },
                                { field: 'rectifyRp', title: '整改人', },
                                { field: 'createName', title: '创建人',   },
                                { field: 'statDate', title: '创建时间', templet: function (d) {
                                        return new Date(d.statDate).pattern('yyyy-MM-dd')
                                    }},
                            ]
                        ],
                        done: function() {
                            $("#TeamTable .layui-table-body").layTableScroll()
                        }
                    })

                }
        });
        //
        // Charts['_table'] = {
        //     resize: function() {
        //         _table.render({
        //             height: $("#table").parent().height()
        //         })
        //     }
        // }
    }

    // 单位得分及排名
    function getCompanyScore() {
        parentPublic.publicGetAjax(parentPublic.middleURL + "/flawScreen/getCompanyScore", undefined , true, {}, function (re) {
            if (re.code == 1) {
                if (re.data) {
                    $("#ranking").text(re.data.ranking)
                    $("#score").text(re.data.score)
                }
            }
        });
    }
    // 单位得分及排名
    function getFlawAll() {
        parentPublic.publicGetAjax(parentPublic.middleURL + "/flawScreen/getFlawAll", undefined , true, {}, function (re) {
            if (re.code == 1) {
                if (re.data) {
                    $("#flawCnt").text(re.data.flawCnt)
                }
            }
        });
    }


    // 获取隐患上报排名Top5
    function getFlawReportRanking() {
        parentPublic.publicGetAjax(parentPublic.middleURL + "/flawScreen/getFlawReportRanking", undefined , true, {}, function (re) {
            if (re.code == 1) {
                if (re.data) {
                    console.log(re.data)
                    initCategoryChart($("#Top5")[0], 'Top5', ["张启超", "良有志", "苏小明", "郑智超", "韩雪峰"]
                        , [78, 74, 63, 56, 54],
                        {
                            xAxis: {
                                axisLabel: {
                                    textStyle: {
                                        color: '#40F3EF'
                                    }
                                }
                            }
                        }
                    )
                }
            }
        });
    }

    // 获取本期隐患趋势统计
    function getFlawTrend(flawTrendType) {
        parentPublic.publicGetAjax(parentPublic.middleURL + "/flawScreen/getFlawTrend", {pageIndex: 0, pageSize: 300, flawTrendType: flawTrendType} , true, {}, function (re) {
            if (re.code == 1) {
                if (re.data) {
                    console.log(re.data)
                    var dates = []
                    var data = []
                    re.data.forEach(function (item) {
                        dates.push(new Date(item.statDate).pattern('yyyy-MM-dd'))
                        data.push(item.flawCnt)
                    })
                    initLineChart($("#Statistics")[0], 'Statistics', dates
                        , data,
                        {
                            xAxis: {
                                axisLabel: {
                                    textStyle: {
                                        color: '#40F3EF'
                                    }
                                }
                            }
                        }

                    )
                }
            }
        });
    }
    // 获取本期隐患专业情况
    function getFlawProfessionalSituation() {
        parentPublic.publicGetAjax(parentPublic.middleURL + "/flawScreen/getFlawProfessionalSituation", undefined , true, {}, function (re) {
            if (re.code == 1) {
                if (re.data) {
                    var data = []
                    re.data.forEach(function (item) {
                        data.push({ name: item.profeName, value: item.flawCnt })
                    })
                    initPieChart($("#State")[0], "State",
                        data,
                        {
                            itemGap: 12
                        }
                    )
                }
            }
        });
    }

    // 获取本期含下属机构的隐患级别分布
    function getFlawLevel() {
        parentPublic.publicGetAjax(parentPublic.middleURL + "/flawScreen/getFlawLevel", undefined , true, {}, function (re) {
            if (re.code == 1) {
                if (re.data) {
                    console.log(re.data)
                    var data = []
                    re.data.forEach(function (item) {
                        data.push({ name: item.flawLevel, value: item.flawCnt })
                    })


                    initPieChart($("#Level")[0], "Level",
                        data
                    )
                }
            }
        });
    }


    $(function (){
        getCompanyScore()
        getFlawAll()

        getFlawReportRanking()

        getFlawTrend(1)

        getFlawProfessionalSituation()

        getFlawLevel()


        // initPie3DChart()
        initPieChart($("#MonthUpdate")[0], "MonthUpdate",
            [
                {name: '本月新增', value: '18'},
                {name: '本月已整改', value: '20'},
                {name: '本月未整改', value: '34'},
                {name: '上月末未整改', value: '12'},
            ],
            {
                series: {
                    radius: ['55%', '80%'],
                },
                itemGap: 12,
                title: {
                    left: '29%',
                    top: '40%',
                    subtext: '整改率',
                    itemGap: 10,
                    textAlign: 'center',
                    text:
                        '{a|88.81%}',
                    subtextStyle: {
                        align: 'center',
                        fontSize: 16,
                        color: "#fff"
                    },
                    textStyle: {
                        align: 'center',
                        rich: {
                            a: {
                                fontSize: 30,
                                padding: [0,0,0,10],
                                fontFamily: 'Impact',
                                color: '#40F3EF',
                            },
                        },
                    },

                },
            }
        )







    })





    $(window).resize(() => {
        for (var key in Charts) {
            if (!Charts[key]) continue
            Charts[key].resize()
        }
    });

</script>
<!--<script src="./js/bigscreen.js"></script>-->
<script src="./js/echarts-component.js"></script>
</body>
</html>